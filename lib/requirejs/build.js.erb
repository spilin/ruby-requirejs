//Download jquery.js and place it in the build, do not use require-jquery.js
//in the build, since each of the build layers just needs almond and not the
//full require.js file.
//This file is run in nodejs to do the build: node build.js

//Load the requirejs optimizer
var requirejs = require("<%= Requirejs.config.runtime_location %>");

//Set up basic config, include config that is
//common to all the requirejs.optimize() calls.
var configs = [
    {
        baseUrl: "<%= Requirejs.config.cache_assets_location %>",
        optimize: "<%= Requirejs.config.js_compressor %>", // For debugging built versions
        wrap: true,
        //All the built layers will use almond.
        name: 'almond',
        include: <%= JSON.pretty_generate( config.include ) %>,
        out: "<%= config.out %>"
    }
]

//Create a runner that will run a separate build for each item
//in the configs array. Thanks to @jwhitley for this cleverness
var runner = configs.reduceRight(function (prev, currentConfig) {
    return function (buildReportText) {
        console.log(buildReportText);
        requirejs.optimize(currentConfig, prev);
    };
}, function (buildReportText) {
    console.log(buildReportText);
});

//Run the builds
runner();